# HR系统数据库关系文档

## 数据库概览

本系统使用 MySQL 数据库，包含 8 个核心表，以 `employees`（员工表）为中心，其他表通过外键关联。

## 表关系图

```
┌─────────────────┐
│   employees     │ (核心表)
│  (员工信息表)    │
└────────┬────────┘
         │ employee_id (PK)
         │
         ├─────────────────┬─────────────────┬─────────────────┬─────────────────┬─────────────────┬─────────────────┐
         │                 │                 │                 │                 │                 │                 │
         ▼                 ▼                 ▼                 ▼                 ▼                 ▼                 ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ leave_balances  │ │     leaves      │ │  attendances    │ │    expenses     │ │    payrolls     │ │    travels      │ │   contracts     │
│  (请假余额表)    │ │   (请假申请表)   │ │   (考勤表)      │ │   (报销表)      │ │   (薪酬表)      │ │  (差旅申请表)   │ │   (合同表)      │
└─────────────────┘ └─────────────────┘ └─────────────────┘ └─────────────────┘ └─────────────────┘ └─────────────────┘ └─────────────────┘
```

## 核心表：employees（员工信息表）

**主键：** `employee_id` (String, 50)

**作用：** 作为整个系统的核心表，存储员工的基本信息。

**字段：**
- `employee_id` - 员工ID（主键）
- `name` - 姓名
- `department` - 部门
- `position` - 职位
- `join_date` - 入职日期
- `address` - 地址
- `created_at` - 创建时间
- `updated_at` - 更新时间

## 表关系详细说明

### 1. employees ↔ leave_balances（一对多）

**关系类型：** 一个员工对应多个年度的请假余额记录

**外键：** `leave_balances.employee_id` → `employees.employee_id`

**说明：** 
- 每个员工每年有一条请假余额记录
- 记录年假和病假的总数、已用数、剩余数
- 通过 `year` 字段区分不同年度

**示例：**
```
员工 E12345
  ├─ 2024年请假余额（年假30天，已用3天）
  └─ 2025年请假余额（年假30天，已用0天）
```

### 2. employees ↔ leaves（一对多）

**关系类型：** 一个员工可以有多条请假申请记录

**外键：** `leaves.employee_id` → `employees.employee_id`

**说明：**
- 记录员工的所有请假申请
- 每条申请有唯一的 `application_id`
- 支持多种请假类型：年假、病假、婚假、产假等

**示例：**
```
员工 E12345
  ├─ 请假申请1：年假，2025-01-01 至 2025-01-03，3天，已批准
  ├─ 请假申请2：病假，2025-02-10 至 2025-02-10，1天，已批准
  └─ 请假申请3：年假，2025-03-15 至 2025-03-20，6天，待审批
```

### 3. employees ↔ attendances（一对多）

**关系类型：** 一个员工有多条考勤记录（每天一条）

**外键：** `attendances.employee_id` → `employees.employee_id`

**唯一约束：** `UNIQUE(employee_id, date)` - 每个员工每天只能有一条考勤记录

**说明：**
- 记录员工每天的考勤情况
- 包含签到时间、签退时间、出勤状态
- 状态包括：出勤、迟到、早退、缺勤

**示例：**
```
员工 E12345
  ├─ 2025-01-15：09:00 签到，18:00 签退，状态：出勤
  ├─ 2025-01-16：09:15 签到，18:00 签退，状态：迟到
  └─ 2025-01-17：09:00 签到，17:30 签退，状态：早退
```

### 4. employees ↔ expenses（一对多）

**关系类型：** 一个员工可以有多条报销记录

**外键：** `expenses.employee_id` → `employees.employee_id`

**说明：**
- 记录员工的所有报销申请
- 每条报销有唯一的 `expense_id`
- 支持多种报销类别：住宿、交通、餐饮等

**示例：**
```
员工 E12345
  ├─ 报销1：交通费，500元，已批准
  ├─ 报销2：住宿费，1200元，待审批
  └─ 报销3：餐饮费，300元，已批准
```

### 5. employees ↔ payrolls（一对多）

**关系类型：** 一个员工有多个月的薪酬记录

**外键：** `payrolls.employee_id` → `employees.employee_id`

**唯一约束：** `UNIQUE(employee_id, month)` - 每个员工每个月只能有一条薪酬记录

**说明：**
- 记录员工每月的薪酬信息
- 包含基本工资、个人所得税、社保
- 月份格式：YYYY-MM

**示例：**
```
员工 E12345
  ├─ 2025-01：工资15000，个税1200，社保800，状态：已发放
  ├─ 2025-02：工资15000，个税1200，社保800，状态：已发放
  └─ 2025-03：工资15000，个税1200，社保800，状态：已发放
```

### 6. employees ↔ travels（一对多）

**关系类型：** 一个员工可以有多条差旅申请记录

**外键：** `travels.employee_id` → `employees.employee_id`

**说明：**
- 记录员工的所有差旅申请
- 每条差旅有唯一的 `travel_id`
- 包含目的地、起止日期、状态等信息

**示例：**
```
员工 E12345
  ├─ 差旅1：北京，2025-01-10 至 2025-01-12，已批准
  └─ 差旅2：上海，2025-02-20 至 2025-02-22，待审批
```

### 7. employees ↔ contracts（一对多）

**关系类型：** 一个员工可以有多份合同记录（历史合同）

**外键：** `contracts.employee_id` → `employees.employee_id`

**说明：**
- 记录员工的合同信息
- 每条合同有唯一的 `contract_id`
- 支持合同续签，可以有多条历史记录
- 状态包括：active（有效）、expired（已过期）、renewed（已续签）

**示例：**
```
员工 E12345
  ├─ 合同1：CT001，到期日2024-12-31，状态：expired（已过期）
  └─ 合同2：CT002，到期日2025-12-31，状态：active（有效）
```

## 关系汇总表

| 关联表 | 关系类型 | 外键字段 | 唯一约束 | 说明 |
|--------|---------|---------|---------|------|
| `leave_balances` | 一对多 | `employee_id` | 无 | 每年一条记录 |
| `leaves` | 一对多 | `employee_id` | 无 | 多条请假申请 |
| `attendances` | 一对多 | `employee_id` | `(employee_id, date)` | 每天一条记录 |
| `expenses` | 一对多 | `employee_id` | 无 | 多条报销记录 |
| `payrolls` | 一对多 | `employee_id` | `(employee_id, month)` | 每月一条记录 |
| `travels` | 一对多 | `employee_id` | 无 | 多条差旅申请 |
| `contracts` | 一对多 | `employee_id` | 无 | 多条合同记录（含历史） |

## 数据完整性约束

### 外键约束
- 所有关联表的外键 `employee_id` 必须引用 `employees.employee_id` 中存在的值
- 删除员工时需要考虑级联删除或先删除关联记录

### 唯一约束
1. **attendances 表：** `UNIQUE(employee_id, date)` - 确保每个员工每天只有一条考勤记录
2. **payrolls 表：** `UNIQUE(employee_id, month)` - 确保每个员工每月只有一条薪酬记录
3. **leaves 表：** `application_id` 唯一 - 确保请假申请ID不重复
4. **expenses 表：** `expense_id` 唯一 - 确保报销ID不重复
5. **travels 表：** `travel_id` 唯一 - 确保差旅ID不重复
6. **contracts 表：** `contract_id` 唯一 - 确保合同ID不重复

## 数据查询示例

### 查询员工及其所有关联信息
```sql
-- 查询员工E12345的完整信息
SELECT * FROM employees WHERE employee_id = 'E12345';

-- 查询该员工的请假余额
SELECT * FROM leave_balances WHERE employee_id = 'E12345';

-- 查询该员工的所有请假申请
SELECT * FROM leaves WHERE employee_id = 'E12345';

-- 查询该员工的考勤记录
SELECT * FROM attendances WHERE employee_id = 'E12345';

-- 查询该员工的报销记录
SELECT * FROM expenses WHERE employee_id = 'E12345';

-- 查询该员工的薪酬记录
SELECT * FROM payrolls WHERE employee_id = 'E12345';

-- 查询该员工的差旅记录
SELECT * FROM travels WHERE employee_id = 'E12345';

-- 查询该员工的合同记录
SELECT * FROM contracts WHERE employee_id = 'E12345';
```

### 使用 JOIN 查询
```sql
-- 查询员工及其请假余额
SELECT e.*, lb.*
FROM employees e
LEFT JOIN leave_balances lb ON e.employee_id = lb.employee_id
WHERE e.employee_id = 'E12345';

-- 查询员工及其最近一个月的薪酬
SELECT e.name, p.month, p.salary, p.tax, p.social_security
FROM employees e
JOIN payrolls p ON e.employee_id = p.employee_id
WHERE e.employee_id = 'E12345'
ORDER BY p.month DESC
LIMIT 1;
```

## 注意事项

1. **级联删除：** 删除员工前，需要先删除或处理所有关联记录，避免外键约束错误
2. **数据一致性：** 确保 `leave_balances` 中的已用天数与 `leaves` 表中的实际请假天数一致
3. **时间字段：** 注意日期和时间的格式，使用 `Date`、`Time`、`DateTime` 类型
4. **状态管理：** 各表的状态字段需要统一管理，避免状态值不一致

## 数据库初始化

系统提供了 `init_db.py` 脚本用于初始化数据库：
- 创建所有表结构
- 插入示例员工数据（E12345, E12346）
- 插入对应的请假余额、薪酬、合同等关联数据

